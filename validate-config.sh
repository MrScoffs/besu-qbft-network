#!/bin/bash

# Script de Valida√ß√£o de Configura√ß√£o da Rede Besu QBFT
# Valida consist√™ncia entre permissions_config.toml e docker-compose.yaml

set -e

echo "========================================="
echo "üîç VALIDA√á√ÉO DE CONFIGURA√á√ÉO BESU QBFT"
echo "========================================="
echo ""

# Cores para output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

errors=0
warnings=0

# Fun√ß√£o de valida√ß√£o
check_pass() {
    echo -e "${GREEN}‚úì${NC} $1"
}

check_fail() {
    echo -e "${RED}‚úó${NC} $1"
    ((errors++))
}

check_warn() {
    echo -e "${YELLOW}‚ö†${NC} $1"
    ((warnings++))
}

echo "üìã 1. Verificando estrutura de diret√≥rios..."
echo "-------------------------------------------"

for i in {1..6}; do
    node_dir="Permissioned-Network/Node-$i/data"
    if [ -d "$node_dir" ]; then
        if [ -f "$node_dir/key" ] && [ -f "$node_dir/key.pub" ] && [ -f "$node_dir/permissions_config.toml" ]; then
            check_pass "Node-$i: Estrutura completa"
        else
            check_fail "Node-$i: Arquivos faltando em $node_dir"
        fi
    else
        check_fail "Node-$i: Diret√≥rio $node_dir n√£o encontrado"
    fi
done

echo ""
echo "üîë 2. Extraindo chaves p√∫blicas dos n√≥s..."
echo "-------------------------------------------"

declare -A node_pubkeys
for i in {1..6}; do
    pubkey_file="Permissioned-Network/Node-$i/data/key.pub"
    if [ -f "$pubkey_file" ]; then
        pubkey=$(cat "$pubkey_file" | sed 's/^0x//')
        node_pubkeys[$i]=$pubkey
        echo "Node-$i: ${pubkey:0:16}...${pubkey: -16}"
    else
        check_fail "Node-$i: Chave p√∫blica n√£o encontrada"
    fi
done

echo ""
echo "üîê 3. Validando permissions_config.toml dos n√≥s..."
echo "-------------------------------------------"

# Ler o primeiro arquivo como refer√™ncia
reference_file="Permissioned-Network/Node-1/data/permissions_config.toml"
if [ ! -f "$reference_file" ]; then
    check_fail "Arquivo de refer√™ncia n√£o encontrado: $reference_file"
    exit 1
fi

reference_hash=$(md5sum "$reference_file" | cut -d' ' -f1)

for i in {2..6}; do
    perm_file="Permissioned-Network/Node-$i/data/permissions_config.toml"
    if [ -f "$perm_file" ]; then
        current_hash=$(md5sum "$perm_file" | cut -d' ' -f1)
        if [ "$current_hash" == "$reference_hash" ]; then
            check_pass "Node-$i: permissions_config.toml id√™ntico ao Node-1"
        else
            check_fail "Node-$i: permissions_config.toml DIFERENTE do Node-1"
        fi
    else
        check_fail "Node-$i: permissions_config.toml n√£o encontrado"
    fi
done

echo ""
echo "üåê 4. Validando enodes em permissions_config.toml..."
echo "-------------------------------------------"

# Extrair enodes do arquivo de permiss√µes
perm_enodes=$(grep -oP 'enode://[^"]+' "$reference_file" | sort)
expected_count=6

actual_count=$(echo "$perm_enodes" | wc -l)
if [ "$actual_count" -eq "$expected_count" ]; then
    check_pass "Quantidade de enodes: $actual_count (esperado: $expected_count)"
else
    check_fail "Quantidade de enodes: $actual_count (esperado: $expected_count)"
fi

# Validar que as chaves p√∫blicas nos enodes correspondem aos arquivos key.pub
echo ""
echo "Validando correspond√™ncia de chaves p√∫blicas..."
while IFS= read -r enode; do
    pubkey=$(echo "$enode" | sed 's/enode:\/\/\([^@]*\).*/\1/')
    host=$(echo "$enode" | sed 's/.*@\([^:]*\):.*/\1/')
    port=$(echo "$enode" | sed 's/.*:\([0-9]*\)$/\1/')

    # Verificar se √© 127.0.0.1
    if [ "$host" == "127.0.0.1" ]; then
        check_pass "Enode usa 127.0.0.1 (porta $port)"
    else
        check_fail "Enode usa $host em vez de 127.0.0.1 (porta $port)"
    fi

    # Verificar se a chave p√∫blica existe nos arquivos
    found=false
    for i in {1..6}; do
        if [ "${node_pubkeys[$i]}" == "$pubkey" ]; then
            found=true
            expected_port=$((30302 + i))
            if [ "$port" -eq "$expected_port" ]; then
                check_pass "Chave Node-$i encontrada com porta correta ($port)"
            else
                check_warn "Chave Node-$i encontrada mas porta incorreta (esperado: $expected_port, atual: $port)"
            fi
            break
        fi
    done

    if [ "$found" == false ]; then
        check_fail "Chave p√∫blica $pubkey n√£o encontrada nos arquivos key.pub"
    fi
done <<< "$perm_enodes"

echo ""
echo "üê≥ 5. Validando bootnodes em docker-compose.yaml..."
echo "-------------------------------------------"

if [ ! -f "docker-compose.yaml" ]; then
    check_fail "docker-compose.yaml n√£o encontrado"
else
    # Extrair bootnodes do docker-compose
    compose_bootnodes=$(grep -oP 'bootnodes=enode://[^"]+' docker-compose.yaml | sed 's/bootnodes=//' | head -1)

    if [ -z "$compose_bootnodes" ]; then
        check_warn "Nenhum bootnode encontrado em docker-compose.yaml"
    else
        # Verificar bootnode 1 (Node-1, porta 30303)
        bootnode1="enode://${node_pubkeys[1]}@127.0.0.1:30303"
        if echo "$compose_bootnodes" | grep -q "${node_pubkeys[1]}@127.0.0.1:30303"; then
            check_pass "Bootnode Node-1 correto no docker-compose.yaml"
        else
            check_fail "Bootnode Node-1 INCORRETO no docker-compose.yaml"
            echo "    Esperado: $bootnode1"
        fi

        # Verificar bootnode 3 (Node-3, porta 30305)
        bootnode3="enode://${node_pubkeys[3]}@127.0.0.1:30305"
        if echo "$compose_bootnodes" | grep -q "${node_pubkeys[3]}@127.0.0.1:30305"; then
            check_pass "Bootnode Node-3 correto no docker-compose.yaml"
        else
            check_fail "Bootnode Node-3 INCORRETO no docker-compose.yaml"
            echo "    Esperado: $bootnode3"
        fi
    fi
fi

echo ""
echo "üìä 6. Validando accounts-allowlist..."
echo "-------------------------------------------"

accounts=$(grep -oP 'accounts-allowlist=\[\K[^\]]+' "$reference_file" | tr -d '"' | tr ',' '\n' | sort)
account_count=$(echo "$accounts" | wc -l)

if [ "$account_count" -eq 6 ]; then
    check_pass "Quantidade de accounts: $account_count (esperado: 6)"
else
    check_fail "Quantidade de accounts: $account_count (esperado: 6)"
fi

# Verificar formato dos endere√ßos
echo "$accounts" | while read -r account; do
    if [[ $account =~ ^0x[0-9a-fA-F]{40}$ ]]; then
        check_pass "Account v√°lido: $account"
    else
        check_fail "Account inv√°lido: $account"
    fi
done

echo ""
echo "üîß 7. Validando configura√ß√£o de rede Docker..."
echo "-------------------------------------------"

# Verificar network_mode
network_mode_count=$(grep -c 'network_mode: "host"' docker-compose.yaml)
if [ "$network_mode_count" -eq 6 ]; then
    check_pass "Todos os 6 n√≥s usam network_mode: host"
else
    check_warn "Network mode host encontrado em $network_mode_count n√≥s (esperado: 6)"
fi

# Verificar portas √∫nicas
echo ""
echo "Verificando portas HTTP RPC..."
for port in 8545 8546 8547 8548 8549 8550; do
    if grep -q "rpc-http-port=$port" docker-compose.yaml; then
        check_pass "Porta HTTP RPC $port configurada"
    else
        check_warn "Porta HTTP RPC $port n√£o encontrada"
    fi
done

echo ""
echo "========================================="
echo "üìà RESUMO DA VALIDA√á√ÉO"
echo "========================================="
echo ""

if [ $errors -eq 0 ] && [ $warnings -eq 0 ]; then
    echo -e "${GREEN}‚úì CONFIGURA√á√ÉO V√ÅLIDA!${NC}"
    echo "  Todos os testes passaram com sucesso."
    exit 0
elif [ $errors -eq 0 ]; then
    echo -e "${YELLOW}‚ö† CONFIGURA√á√ÉO V√ÅLIDA COM AVISOS${NC}"
    echo "  Erros: $errors"
    echo "  Avisos: $warnings"
    exit 0
else
    echo -e "${RED}‚úó CONFIGURA√á√ÉO INV√ÅLIDA!${NC}"
    echo "  Erros: $errors"
    echo "  Avisos: $warnings"
    echo ""
    echo "Por favor, corrija os erros antes de iniciar a rede."
    exit 1
fi
